<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Find Nearest Hospital</title>
  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body { padding: 2rem; }
    #results .list-group-item { cursor: pointer; }
    .distance { font-size: 0.9rem; color: #666; }
    .meta { font-size: 0.85rem; margin-top: 0.25rem; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Find Nearest Hospital</h2>

    <!-- Controls: Location | Insurance | Department -->
    <div class="row mb-3">
      <div class="col-md-4">
        <div class="input-group">
          <input
            type="text"
            id="locationInput"
            class="form-control"
            placeholder="Enter ZIP, city, or state"
          />
          <button id="searchBtn" class="btn btn-primary">Search</button>
          <button id="geoBtn" class="btn btn-secondary">Use My Location</button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="input-group">
          <label class="input-group-text" for="insuranceSelect">Insurance</label>
          <select id="insuranceSelect" class="form-select">
            <option value="">All Plans</option>
          </select>
        </div>
      </div>
      <div class="col-md-4">
        <div class="input-group">
          <label class="input-group-text" for="deptSelect">Department</label>
          <select id="deptSelect" class="form-select">
            <option value="">All Types</option>
          </select>
        </div>
      </div>
    </div>

    <div id="results"></div>
  </div>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const HOSP_CSV = 
      'https://raw.githubusercontent.com/RealRadOne/AMS_Project/master/data/hospital_location.csv';
    const PAT_CSV =
      'https://raw.githubusercontent.com/RealRadOne/AMS_Project/master/data/patient_data.csv';

    let hospitals = [];
    const insuranceMap = {};  // hospitalName → Set(insurances)
    let loadedHosp = false, loadedPat = false;

    // 1️⃣ Load hospitals, build department list
    Papa.parse(HOSP_CSV, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => {
        hospitals = res.data;
        loadedHosp = true;

        // collect unique TYPE values
        const types = new Set(hospitals.map(h=>h.TYPE).filter(Boolean));
        const deptSel = document.getElementById('deptSelect');
        Array.from(types).sort().forEach(t => {
          const o = document.createElement('option');
          o.value = t; o.textContent = t;
          deptSel.appendChild(o);
        });
      }
    });

    // 2️⃣ Load patients, build insurance map & dropdown
    Papa.parse(PAT_CSV, {
      download: true, header: true, skipEmptyLines: true,
      complete: res => {
        const insSet = new Set();
        res.data.forEach(r => {
          const h = r.Hospital, i = r['Insurance Provider'];
          if (!insuranceMap[h]) insuranceMap[h] = new Set();
          insuranceMap[h].add(i);
          insSet.add(i);
        });
        const insSel = document.getElementById('insuranceSelect');
        Array.from(insSet).sort().forEach(i => {
          const o = document.createElement('option');
          o.value = i; o.textContent = i;
          insSel.appendChild(o);
        });
        loadedPat = true;
      }
    });

    // 3️⃣ Wire up buttons
    document.getElementById('searchBtn').onclick = () => {
      if (!loadedHosp||!loadedPat) return alert('Data still loading…');
      doSearch();
    };
    document.getElementById('geoBtn').onclick = () => {
      if (!loadedHosp||!loadedPat) return alert('Data still loading…');
      doGeo();
    };

    function doSearch() {
      const q = document.getElementById('locationInput').value.trim();
      if (!q) return alert('Enter a ZIP, city, or state.');
      let list = [];
      if (/^\d{5}$/.test(q)) {
        list = hospitals.filter(h=>h.ZIP===q);
      } else {
        const L = q.toLowerCase();
        list = hospitals.filter(h=>
          h.CITY.toLowerCase()===L || h.STATE.toLowerCase()===L
        );
      }
      filterAndShow(list);
    }

    function doGeo() {
      if (!navigator.geolocation) return alert('Geolocation unsupported');
      navigator.geolocation.getCurrentPosition(
        p => {
          const {latitude,longitude}=p.coords;
          const withDist = hospitals.map(h=>({
            ...h,
            distance: haversine(
              latitude,longitude,
              parseFloat(h.LATITUDE),
              parseFloat(h.LONGITUDE)
            )
          }));
          withDist.sort((a,b)=>a.distance-b.distance);
          filterAndShow(withDist);
        },
        ()=>alert('Geolocation failed')
      );
    }

    // apply insurance & department filters
    function filterAndShow(list) {
      const selIns = document.getElementById('insuranceSelect').value;
      const selDept= document.getElementById('deptSelect').value;
      let out = list;
      if (selIns) {
        out = out.filter(h=>
          (insuranceMap[h.NAME]||new Set()).has(selIns)
        );
      }
      if (selDept) {
        out = out.filter(h=>h.TYPE===selDept);
      }
      render(out);
    }

    // render results
    function render(arr) {
      const c = document.getElementById('results');
      if (!arr.length) {
        c.innerHTML = '<div class="alert alert-warning">No hospitals found.</div>';
        return;
      }
      c.innerHTML = `
        <div class="list-group">
          ${arr.map(h=>`
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <h5>${h.NAME}</h5>
                  <p class="mb-1">
                    ${h.ADDRESS}, ${h.CITY}, ${h.STATE} ${h.ZIP}
                  </p>
                  <small class="meta">
                    Insurance: ${Array.from(insuranceMap[h.NAME]||[]).join(', ')}
                  </small><br/>
                  <small class="meta">
                    Department: ${h.TYPE}
                  </small>
                </div>
                ${h.distance!=null
                  ? `<span class="distance">${h.distance.toFixed(1)} km</span>`
                  : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Haversine (km)
    function haversine(lat1, lon1, lat2, lon2) {
      const toR=d=>d*Math.PI/180;
      const dLat=toR(lat2-lat1), dLon=toR(lon2-lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toR(lat1)) *
                Math.cos(toR(lat2)) *
                Math.sin(dLon/2)**2;
      return 6371*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
  </script>
</body>
</html>
